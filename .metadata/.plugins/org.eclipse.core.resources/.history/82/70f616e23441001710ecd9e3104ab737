/* 소켓 프로그래밍: connectionful 서버 만들기 */

package step18;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.PrintStream;
import java.net.ServerSocket;
import java.net.Socket;

import com.google.gson.Gson;

public class ChatApp2 {
  
  class Value {
    String userId;
    String content;
  }
  
  class ChatServer implements Runnable {
    Socket socket ;
    
    public ChatServer(Socket socket) {
      this.socket = socket;
      System.out.println("=> 클라이언트와 연결되었음!");
    }// ChatServer()
    
    public void run() {
      int count = 0;
      try 
      (
      Socket socket = this.socket;
      BufferedReader in = new BufferedReader(
          new InputStreamReader(socket.getInputStream()));
      PrintStream out = new PrintStream(socket.getOutputStream());
      ) {
        while (true) {
        String json = in.readLine();
        if (json == null)
          break;
        
        // Gson 객체를 이용해 JSON 문자열을 Value 객체로 만든다.
        // Gson 라이브러리 추가
        // 1) build.gradle 에 repositories{}, dependencies {} 블록 추가
        // 2) 명령창에서 "gradle eclipse"를 실행하여 이클립스 설정 파일 갱신
        // 3) 이클립스에서 프로젝트 "refresh" 할 것
        Gson gson = new Gson();
        Value value = gson.fromJson(json, Value.class);
        
        out.flush();
        } //while
        System.out.println("=> 클라이언트와 연결 끊김!");
      } catch (Exception e) {
        e.printStackTrace();
      }
    } // run()
    
  } // class ChatServer
  
  public void Listen(int port) throws Exception {
    ServerSocket serverSocket = new ServerSocket(port);
    System.out.println("step18 Test07_1 서버 실행중");
    
    while (true) {
      new Thread(new ChatServer(serverSocket.accept())).start();
      
      
    } // while
    
  } // class Listen()
  
  public static void main(String[] args) throws Exception {
    
    ChatApp2 server = new ChatApp2();
    
    server.Listen(8888);
    
  }  // main
}
